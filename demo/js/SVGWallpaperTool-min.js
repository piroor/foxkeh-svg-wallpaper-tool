/*!
 * Copyright 2011, Mozilla Japan.
 * Dual licensed under the MIT or GPL Version 3 licenses.
 * https://bitbucket.org/foxkeh/svg-wallpaper-tool/src/tip/MIT-LICENSE.txt
 * https://bitbucket.org/foxkeh/svg-wallpaper-tool/src/tip/GPL-LICENSE.txt
 *
 * Includes Modernizr.js  
 * www.modernizr.com
 * Developed by: 
 * - Faruk Ates  http://farukat.es/
 * - Paul Irish  http://paulirish.com/
 * Copyright (c) 2009-2011
 * Dual-licensed under the BSD or MIT licenses.
 * http://www.modernizr.com/license/
 *
 */

(function(global){function loadSVG(url,callback){var xhr=new XMLHttpRequest();xhr.open('GET',url,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status==200&&xhr.responseXML){var svg=xhr.responseXML.getElementsByTagName("svg")[0];svg=document.importNode(svg,true);callback(svg);this.svg=svg;}}};xhr.send(null);};if(typeof SVGUtil=="undefined"){global.SVGUtil={};}
global.SVGUtil.loadSVG=loadSVG;})(this);(function(global){var SVGBBoxTool=function(SVGSprite,options){options=(typeof options=="undefined")?{}:options;this.SVGSprite=SVGSprite;this.isSafari=(navigator.userAgent.indexOf("Safari")!=-1&&navigator.userAgent.indexOf("Chrome")==-1);this.options={scale:(typeof options.scale=="boolean")?options.scale:true,rotation:(typeof options.rotation=="boolean")?options.rotation:true}
this.center=document.createElementNS("http://www.w3.org/2000/svg","circle");this.point=document.createElementNS("http://www.w3.org/2000/svg","circle");this.SVGSprite.svgElement.ownerSVGElement.appendChild(this.center);this.SVGSprite.svgElement.ownerSVGElement.appendChild(this.point);this.init();};SVGBBoxTool.prototype.init=function(){this.origMouseX=this.origMouseY=this._rotateInitRotate=null;this.origWidth=this.SVGSprite.width;this.origHeight=this.SVGSprite.height;var _bbox=document.createElementNS("http://www.w3.org/2000/svg","rect");_bbox.setAttribute("width",this.origWidth);_bbox.setAttribute("height",this.origHeight);this._bbox=_bbox;var _scaleBox=document.createElementNS("http://www.w3.org/2000/svg","g");var _scaleSVGSrc='<svg xmlns="http://www.w3.org/2000/svg">';_scaleSVGSrc+='<g id="scale">';_scaleSVGSrc+='<rect width="20" height="20" x="0" y="0" style="color:#000000;fill:#ffffff;stroke:#000000;stroke-width:0.5" />';_scaleSVGSrc+='<g transform="translate(0, -6)">';_scaleSVGSrc+='<path d="M 4.730198,11.40495 15.722277,22.397029" style="fill:none;stroke:#000000;stroke-width:0.5;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" />';_scaleSVGSrc+='<path d="m 8.4005759,8.3507412 -4.1659224,-10e-8 -4.16592245,0 L 2.1516922,4.7429466 4.2346535,1.1351519 6.3176146,4.7429464 z" ';_scaleSVGSrc+='transform="matrix(0.51977901,-0.51977901,0.51977901,0.51977901,-0.95968357,9.9839171)" ';_scaleSVGSrc+='style="color:#000000;fill:#000000;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:0.505;marker:none;visibility:visible;display:inline;overflow:visible;enable-background:accumulate" />';_scaleSVGSrc+='<path d="m 8.4005759,8.3507412 -4.1659224,-10e-8 -4.16592245,0 L 2.1516922,4.7429466 4.2346535,1.1351519 6.3176146,4.7429464 z" ';_scaleSVGSrc+='transform="matrix(-0.51977901,0.51977901,-0.51977901,-0.51977901,20.372362,22.713437)" ';_scaleSVGSrc+='style="color:#000000;fill:#000000;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:0.505;marker:none;visibility:visible;display:inline;overflow:visible;enable-background:accumulate" />';_scaleSVGSrc+='</g>';_scaleSVGSrc+='</g>';_scaleSVGSrc+='</svg>';var parser=new DOMParser()
var _scaleSVGXML=parser.parseFromString(_scaleSVGSrc,"text/xml");var _scaleSVG=document.adoptNode(_scaleSVGXML.getElementById("scale"));_scaleSVG.setAttribute("transform","scale("+1/this.SVGSprite._viewPortScaleX+")");_scaleBox.appendChild(_scaleSVG);this._scaleBox=_scaleBox;var _rotateBox=document.createElementNS("http://www.w3.org/2000/svg","g");var _rotateSVGSrc='<svg xmlns="http://www.w3.org/2000/svg">';_rotateSVGSrc+='<g id="rotate">';_rotateSVGSrc+='<rect width="20" height="20" x="0" y="0" style="color:#000000;fill:#ffffff;stroke:#000000;stroke-width:0.5" />';_rotateSVGSrc+='<g transform="translate(0, -6)">';_rotateSVGSrc+='<path d="m 8.4005759,8.3507412 -4.1659224,-10e-8 -4.16592245,0 L 2.1516922,4.7429466 4.2346535,1.1351519 6.3176146,4.7429464 z"';_rotateSVGSrc+='  transform="matrix(0,0.73507853,-0.73507853,0,19.836613,7.6490556)"';_rotateSVGSrc+='  style="color:#000000;fill:#000000;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:0.505;marker:none;visibility:visible;display:inline;overflow:visible;enable-background:accumulate" />';_rotateSVGSrc+='<path d="m 8.4005759,8.3507412 -4.1659224,-10e-8 -4.16592245,0 L 2.1516922,4.7429466 4.2346535,1.1351519 6.3176146,4.7429464 z"';_rotateSVGSrc+='  transform="matrix(-0.73507853,0,0,-0.73507853,7.6878788,25.768073)"';_rotateSVGSrc+='  style="color:#000000;fill:#000000;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:0.505;marker:none;visibility:visible;display:inline;overflow:visible;enable-background:accumulate" />';_rotateSVGSrc+='<path d="m 4.3217759,21.80785 c 0,-6.426081 4.9898167,-11.635449 11.1450671,-11.635449"';_rotateSVGSrc+='  style="color:#000000;fill:none;stroke:#000000;stroke-width:0.40038314;stroke-opacity:1;marker:none;visibility:visible;display:inline;overflow:visible;enable-background:accumulate" />';_rotateSVGSrc+='</g></g>';_rotateSVGSrc+='</svg>';var _rotateSVGXML=(new DOMParser()).parseFromString(_rotateSVGSrc,"text/xml");var _rotateSVG=document.adoptNode(_rotateSVGXML.getElementById("rotate"));_rotateSVG.setAttribute("transform","scale("+1/this.SVGSprite._viewPortScaleX+")");_rotateBox.appendChild(_rotateSVG);this._rotateBox=_rotateBox;this._setBoxes();var self=this;$(this._scaleBox).mousedown(function(e){self._startScale();});$(this._rotateBox).mousedown(function(e){self._startRotate();});$(window).mousemove(function(e){self._doScale(e);self._doRotate(e);});window.addEventListener('mouseup',function(e){self._endScale();self._endRotate();},true);};SVGBBoxTool.prototype._setBoxes=function(){var strokeWidth=(20/Math.abs(this.SVGSprite.scaleX))/this.SVGSprite._viewPortScaleX;var boxWidth=(20/this.SVGSprite.scaleX);var _bbox=this._bbox;_bbox.setAttribute("x",this.SVGSprite._svgTransformUtil.origOffset.x);_bbox.setAttribute("y",this.SVGSprite._svgTransformUtil.origOffset.y);_bbox.setAttribute("style","opacity:0.6; fill:#fff; stroke:#fff; stroke-width:"+strokeWidth+"; stroke-linejoin:round;");var _scaleBox=this._scaleBox;var _scaleX=(this.SVGSprite._svgTransformUtil.origOffset.x+this.origWidth-(boxWidth*.5))*this.SVGSprite.scaleX;var _scaleY=(this.SVGSprite._svgTransformUtil.origOffset.y+this.origHeight-(boxWidth*.5))*this.SVGSprite.scaleX;_scaleBox.setAttribute("transform","scale("+1/this.SVGSprite.scaleX+") translate("+_scaleX+", "+_scaleY+")");_scaleBox.setAttribute("style","cursor:se-resize");var _rotateBox=this._rotateBox;var _rotateX=(this.SVGSprite._svgTransformUtil.origOffset.x-(boxWidth*.8))*(this.SVGSprite.scaleX);var _rotateY=(this.SVGSprite._svgTransformUtil.origOffset.y-(boxWidth*.8))*(this.SVGSprite.scaleX);_rotateBox.setAttribute("transform","scale("+1/this.SVGSprite.scaleX+") translate("+_rotateX+", "+_rotateY+")");_rotateBox.setAttribute("style","cursor:pointer");};SVGBBoxTool.prototype.enable=function(){this.SVGSprite._svgTransformUtil.transformWrapper.appendChild(this._bbox);this.SVGSprite._svgTransformUtil.transformWrapper.appendChild(this.SVGSprite._oapcityElement);this.SVGSprite._svgTransformUtil.transformWrapper.appendChild(this._scaleBox);this.SVGSprite._svgTransformUtil.transformWrapper.appendChild(this._rotateBox);};SVGBBoxTool.prototype.disable=function(){this.SVGSprite._svgTransformUtil.transformWrapper.removeChild(this._bbox);this.SVGSprite._svgTransformUtil.transformWrapper.removeChild(this._scaleBox);this.SVGSprite._svgTransformUtil.transformWrapper.removeChild(this._rotateBox);};SVGBBoxTool.prototype._startScale=function(){this._scaling=true;this._scaleOrigWidth=this.SVGSprite.width;this._scaleOrigHeight=this.SVGSprite.height;};SVGBBoxTool.prototype._doScale=function(event){if(this._scaling){if(this.origMouseX==null){this.origScreenCTM=this.SVGSprite._svgTransformUtil.transformWrapper.getScreenCTM();}
var x=(this.isSafari)?event.pageX:event.pageX-$(window).scrollLeft();var y=(this.isSafari)?event.pageY:event.pageY-$(window).scrollTop();var ctm=this.origScreenCTM;var p=this.SVGSprite.svgElement.ownerSVGElement.createSVGPoint();p.x=x;p.y=y;p=p.matrixTransform(ctm.inverse());if(this.origMouseX==null){this.origMouseX=p.x;this.origScaleX=this.SVGSprite.scaleX;this.origFlipped=((this.SVGSprite.scaleY<0&&this.origScaleX>0)||(this.SVGSprite.scaleY>0&&this.origScaleX<0));}
var ratio=(p.x-(this.origMouseX/2))/(this.origMouseX/2);var scale=this.origScaleX*ratio;this.SVGSprite.scaleX=scale;this.SVGSprite.scaleY=(this.origFlipped)?-scale:scale;this._setBoxes();}};SVGBBoxTool.prototype._endScale=function(){this._scaling=false;this.origMouseX=this.origMouseY=null;};SVGBBoxTool.prototype._startRotate=function(){this._rotation=true;this._rotateOrigRotation=this.SVGSprite.rotation;this._rotateOrigX=this.SVGSprite.x;this._rotateOrigY=this.SVGSprite.y;};SVGBBoxTool.prototype._doRotate=function(event){if(this._rotation){var clientX=event.layerX/this.SVGSprite._viewPortScaleX;var clientY=event.layerY/this.SVGSprite._viewPortScaleX;if(this._rotateInitRotate==null){var _x=(clientX*this.SVGSprite._viewPortScaleX)-this._rotateOrigX;var _y=(clientY*this.SVGSprite._viewPortScaleY)-this._rotateOrigY;var _radian=Math.atan2(_y,_x);var _rotation=_radian/(Math.PI/180);this._rotateInitRotate=_rotation;}
var x=(clientX)-this._rotateOrigX;var y=(clientY)-this._rotateOrigY;var radian=Math.atan2(y,x);var rotation=(radian/(Math.PI/180))-this._rotateInitRotate;this.SVGSprite.rotation=this._rotateOrigRotation+rotation;this._setBoxes();}};SVGBBoxTool.prototype._endRotate=function(){this._rotation=false;this._rotateInitRotate=null;};global.SVGBBoxTool=SVGBBoxTool;})(this);(function(global){var SVGDropBox=function(option){option=option||{};this.imageWidth=option.width||100;this.imageHeight=option.height||100;this.validFile=false;this.init();};SVGDropBox.MIMETYPE={svg:"image/svg+xml",jpeg:"image/png",png:"image/jpeg",gif:"image/gif"};SVGDropBox.prototype.init=function(){this.element=document.createElement("div");if(typeof FileReader==='undefined'){return;}
this.className="SVGDropBox";this.element.className=this.className;if(this.isDropSupported()){var p=document.createElement("p");p.innerHTML="drop File";var self=this;this.element.addEventListener("dragenter",function(e){e.stopPropagation();e.preventDefault();self.element.className=self.className+" SVGDropBoxDragover";},false);this.element.addEventListener("dragover",function(e){e.stopPropagation();e.preventDefault();},false);this.element.addEventListener("dragleave",function(e){e.stopPropagation();e.preventDefault();self.element.className=(typeof self.content=="undefined")?self.className:self.className+" SVGDropBOXDroped";},false);this.element.addEventListener("drop",function(e){e.stopPropagation();e.preventDefault();self.element.className=self.className;var dt=e.dataTransfer;var files=dt.files;if(files.length>0){self.loadFile(files[0]);}},false);this.element.appendChild(p);}else{var p=document.createElement("p");p.innerHTML="select File";var input=document.createElement("input");input.setAttribute("type","file");var self=this;input.addEventListener("change",function(e){var file=e.currentTarget.files[0];self.loadFile(file);},false);this.element.appendChild(p);this.element.appendChild(input);}};SVGDropBox.prototype.isDropSupported=function(){var element=document.createElement('div');var eventName='ondrop';var isSupported=(eventName in element);if(!isSupported){if(!element.setAttribute){element=document.createElement('div');}
if(element.setAttribute&&element.removeAttribute){element.setAttribute(eventName,'');isSupported=typeof element[eventName]=='function';if(typeof element[eventName]!='undefined'){element[eventName]=undefined;}
element.removeAttribute(eventName);}}
element=null;return isSupported;};SVGDropBox.prototype.isSVG=function(file){return(file.type==SVGDropBox.MIMETYPE.svg);};SVGDropBox.prototype.isImage=function(file){var type=file.type;return(type==SVGDropBox.MIMETYPE.jpeg||type==SVGDropBox.MIMETYPE.gif||type==SVGDropBox.MIMETYPE.png);}
SVGDropBox.prototype.loadFile=function(file){if(file.size>0){this.fileType=this.isSVG(file)?"svg":this.isImage(file)?"image":"other";var reader=new FileReader();var self=this;reader.onload=function(e){self.onFileLoaded(e);};if(this.fileType=="svg"){reader.readAsText(file,"utf-8");this.validFile=true;}else if(this.fileType=="image"){reader.readAsDataURL(file);this.validFile=true;}}};SVGDropBox.prototype.onFileLoaded=function(e){var result=e.target.result;var container=document.createElement("div");container.className="SVGDropBoxContainer";if(this.fileType=="svg"){var parser=new DOMParser();var svgDoc=parser.parseFromString(result,"text/xml");var svgElement=document.importNode(svgDoc.getElementsByTagName("svg")[0],true);var width=svgElement.width.baseVal.value;var height=svgElement.height.baseVal.value;var aspect=height/width;var imageWidth=(this.imageWidth*aspect<this.imageHeight)?this.imageWidth:this.imageHeight/aspect;var imageHeight=(this.imageWidth*aspect<this.imageHeight)?this.imageWidth*aspect:this.imageHeight;svgElement.setAttribute("viewBox","0 0 "+width+" "+height);svgElement.setAttribute("width",imageWidth);svgElement.setAttribute("height",imageHeight);var contentElement=svgElement;result=svgDoc.getElementsByTagName("svg")[0];}else if(this.fileType=="image"){var image=document.createElement("img");image.src=result;image.setAttribute("width",this.imageWidth);var contentElement=image;}
container.appendChild(contentElement);var children=this.element.childNodes;for(var i=0,l=children.length;i<l;i++){this.element.removeChild(children[i]);}
this.element.appendChild(container);this.element.className=self.className+" SVGDropBOXDroped";this.contentElement=contentElement;this.container=container;this.content=result;};global.SVGDropBox=SVGDropBox;})(window);(function(global){function defineSetterGetter(obj,name,setter,getter){if(!Object.prototype.__defineSetter__&&Object.defineProperty({},"x",{get:function(){return true}}).x){Object.defineProperty(obj,name,{set:setter,get:getter});}else if(Object.prototype.__defineSetter__){obj.__defineSetter__(name,setter);obj.__defineGetter__(name,getter);}};var SVGWallpaperTool={};SVGWallpaperTool.SVGWallpaperTool=function(param){if(!param){return;}
if(param.wallpaperSVG){this.wallpaper=new SVGWallpaperTool.Wallpaper($("#"+param.wallpaperSVG)[0]);}else{return;}
if(param.sizeSelector){var select=$("#"+param.sizeSelector);this.sizeSelectorView=new SVGWallpaperTool.WallpaperSizeSelectorView(select);this.sizeSelectorController=new SVGWallpaperTool.WallpaperSizeSelectorController(this.sizeSelectorView,this.wallpaper);}
if(param.backgroundList){var list=$("#"+param.backgroundList);this.backgroundListController=new SVGWallpaperTool.BackgroundListController(this.wallpaper,list);}
if(param.partsList){var partsList=$("#"+param.partsList);this.partsListView=new SVGWallpaperTool.PartsListView(partsList);this.partsListController=new SVGWallpaperTool.PartsListController(this.wallpaper,this.partsListView);}
if(param.downLoadButton){var button=$("#"+param.downLoadButton);this.downloadButtonController=new SVGWallpaperTool.DownloadButtonController(this.wallpaper,button);}
if(param.partsControll){var partsControll=$("#"+param.partsControll);var options={scale:param.scaleOptions,alpha:param.alphaOptions,rotation:param.rotationOptions};this.partsControllView=new SVGWallpaperTool.PartsControllView(this.wallpaper,partsControll,options);this.partsControllController=new SVGWallpaperTool.PartsControllController(this.wallpaper,this.partsControllView);}
if(param.indicator){var indicator=$("#"+param.indicator);this.indicatorView=new SVGWallpaperTool.IndicatorView(this.wallpaper,indicator);}
if(param.copyright){this.wallpaper.loadCopyright(param.copyright);}
if(param.background){this.wallpaper.loadBackground(param.background);}
if(param.parts){for(var i=0,l=param.parts.length;i<l;i++){this.wallpaper.loadParts({file:param.parts[i]});}}};SVGWallpaperTool.Wallpaper=function(svg,partsLimit){this.svg=svg;this._origWidth=svg.width.baseVal.value;this.partsLimit=(typeof partsLimit=="number")?partsLimit:5;this.parts=[];this.activeParts=null;this._loadingObjects=[];this.init();};SVGWallpaperTool.Wallpaper.prototype.init=function(){var backgroundLayer=document.createElementNS("http://www.w3.org/2000/svg","g");backgroundLayer.setAttribute("class","wallpaperBackground");var partsLayer=document.createElementNS("http://www.w3.org/2000/svg","g");partsLayer.setAttribute("class","wallpaperParts");var copyrightLayer=document.createElementNS("http://www.w3.org/2000/svg","g");copyrightLayer.setAttribute("class","wallpaperCopyright");this._backgroundLayer=backgroundLayer;this._partsLayer=partsLayer;this._copyrightLayer=copyrightLayer;this.svg.appendChild(this._backgroundLayer);this.svg.appendChild(this._partsLayer);this.svg.appendChild(this._copyrightLayer);var self=this;window.addEventListener('mousemove',function(){self._refresh();},true);$(this._backgroundLayer).click(function(){self.deactivateParts();});};SVGWallpaperTool.Wallpaper.prototype._addLoadingObjects=function(url){this._loadingObjects.push(url);$(this).trigger("load_start");var index=this._loadingObjects.length-1;return index;};SVGWallpaperTool.Wallpaper.prototype._removeLoadingObjects=function(index){this._loadingObjects[index]="";$(this).trigger("load_complete");if(this._loadingObjects.join("")==""){$(this).trigger("load_all_complete");}};SVGWallpaperTool.Wallpaper.prototype._refresh=function(){$(this.svg).hide().show();};SVGWallpaperTool.Wallpaper.prototype.setViewBox=function(width,height){var _width=this._origWidth;var _height=Math.floor(_width*(height/width));this.svg.setAttribute("width",_width);this.svg.setAttribute("height",_height);this.svg.setAttribute("viewBox","0 0 "+width+" "+height);this._adjustmentCopyrightSize();this._adjustmentBackgroundSize();};SVGWallpaperTool.Wallpaper.prototype.getViewBox=function(){return this.svg.viewBox.baseVal;};SVGWallpaperTool.Wallpaper.prototype.setCopyright=function(svgElement){if(this._copyright){this._copyrightLayer.removeChild(this._copyright.svgElement);}
this._copyrightLayer.appendChild(svgElement);var copyright=new SVGSprite.Sprite(svgElement);this._copyright=copyright;this._adjustmentCopyrightSize();};SVGWallpaperTool.Wallpaper.prototype._adjustmentCopyrightSize=function(){if(this._copyright){var viewBox=this.getViewBox();var width=this._copyright.width;var height=this._copyright.height;this._copyright.x=viewBox.width-(width/2)-10;this._copyright.y=viewBox.height-(height/2)-5;this._refresh();}};SVGWallpaperTool.Wallpaper.prototype.loadCopyright=function(url){var self=this;var index=this._addLoadingObjects(url);SVGUtil.loadSVG(url,function(svg){self.setCopyright(svg);self._removeLoadingObjects(index);});};SVGWallpaperTool.Wallpaper.prototype.setBackground=function(svgElement){if(this._background){this._backgroundLayer.removeChild(this._background.svgElement);}
this._backgroundLayer.appendChild(svgElement);var background=new SVGSprite.Sprite(svgElement);this._background=background;this._adjustmentBackgroundSize();};SVGWallpaperTool.Wallpaper.prototype._adjustmentBackgroundSize=function(){if(this._background){var viewBox=this.getViewBox();var width=viewBox.width;var height=viewBox.height;var viewBoxAspect=width/height;var bgAspect=this._background.width/this._background.height;if(viewBoxAspect<bgAspect){width=height*bgAspect;}else{height=bgAspect/width;}
var deltaWidth=width-viewBox.width;var deltaHeight=height-viewBox.height;this._background.width=width;this._background.height=height;this._background.x=(viewBox.width/2)-(deltaWidth/2);this._background.y=(viewBox.height/2)-(deltaHeight/2);this._refresh();}};SVGWallpaperTool.Wallpaper.prototype.loadBackground=function(url){var self=this;var index=this._addLoadingObjects(url);SVGUtil.loadSVG(url,function(svg){self.setBackground(svg);self._removeLoadingObjects(index);});};SVGWallpaperTool.Wallpaper.prototype.addParts=function(parts){if(this.parts.length<this.partsLimit){this.parts.push(parts);parts.index=this.parts.length-1;parts.appendTo(this._partsLayer);this._refresh();var self=this;$(parts).bind("activated",function(e){self._activatedPartsHandler(e);});}else{$(this).trigger('parts_fulled');}};SVGWallpaperTool.Wallpaper.prototype.removeParts=function(parts){var newPartsList=[];for(var i=0,l=this.parts.length;i<l;i++){if(i!=parts.index){newPartsList.push(this.parts[i]);this.parts[i].index=newPartsList.length-1;}}
this.parts=newPartsList;parts.svgElement.parentNode.removeChild(parts.svgElement);if(parts===this.activeParts){this.activeParts=null;$(this).trigger("parts_deactivated");}
delete parts;};SVGWallpaperTool.Wallpaper.prototype._activatedPartsHandler=function(e){var parts=e.currentTarget;this.activeParts=parts;for(var i=0,l=this.parts.length;i<l;i++){if(i!=parts.index){this.parts[i].deactive();}}
var self=this;$(this).trigger("parts_activated");};SVGWallpaperTool.Wallpaper.prototype.deactivateParts=function(e){for(var i=0,l=this.parts.length;i<l;i++){this.parts[i].deactive();}
this.activeParts=null;$(this).trigger("parts_deactivated");};SVGWallpaperTool.Wallpaper.prototype.loadParts=function(param){var self=this;if(typeof param.svgElement!="undefined"&&param.svgElement instanceof SVGElement){var parts=new SVGWallpaperTool.Parts(param.svgElement);var viewBox=self.getViewBox();var viewBox=this.getViewBox();parts.x=viewBox.width/2;parts.y=viewBox.height/2;this.addParts(parts);}else{var index=this._addLoadingObjects(param.file);SVGUtil.loadSVG(param.file,function(svg){var parts=new SVGWallpaperTool.Parts(svg);var viewBox=self.getViewBox();parts.x=viewBox.width/2;parts.y=viewBox.height/2;self._removeLoadingObjects(index);self.addParts(parts);});}};SVGWallpaperTool.Wallpaper.prototype.upPartsIndex=function(parts){var currentIndex=parts.index;var targetIndex=currentIndex+1;if(targetIndex<this.parts.length){var target=this.parts[targetIndex];this.parts[targetIndex]=parts;this.parts[currentIndex]=target;parts.index=targetIndex;target.index=currentIndex;for(var i=0,l=this.parts.length;i<l;i++){this._partsLayer.removeChild(this.parts[i].svgElement);}
for(var i=0,l=this.parts.length;i<l;i++){this._partsLayer.appendChild(this.parts[i].svgElement);}}};SVGWallpaperTool.Wallpaper.prototype.downPartsIndex=function(parts){var currentIndex=parts.index;var targetIndex=currentIndex-1;if(currentIndex>0){var target=this.parts[targetIndex];this.parts[targetIndex]=parts;this.parts[currentIndex]=target;parts.index=targetIndex;target.index=currentIndex;for(var i=0,l=this.parts.length;i<l;i++){this._partsLayer.removeChild(this.parts[i].svgElement);}
for(var i=0,l=this.parts.length;i<l;i++){this._partsLayer.appendChild(this.parts[i].svgElement);}}};SVGWallpaperTool.Wallpaper.prototype.toDataURL=function(){var tmpSVG=this.svg.cloneNode(true);var viewBox=this.getViewBox();tmpSVG.setAttribute("width",viewBox.width);tmpSVG.setAttribute("height",viewBox.height);var serialzedSVG=new XMLSerializer().serializeToString(tmpSVG);var svgBase64=';base64,'+Base64.encode(serialzedSVG);var mimeType="application/octet-stream";var dataURL="data:"+mimeType+svgBase64;delete tmpSVG;return dataURL;};SVGWallpaperTool.Parts=function(svgElement){this.constructor(svgElement);this.index=null;this.scale=1;this.active=false;this.buttonMode=true;this.SVGBBoxTool=null;var self=this;this.addEventListener("mousedown",function(){self.activate();},false);};SVGWallpaperTool.Parts.prototype=new SVGSprite.Sprite;SVGWallpaperTool.Parts.prototype.setSvgElement=function(svgElement){this._svgElement=svgElement;};SVGWallpaperTool.Parts.prototype.appendTo=function(content){content.appendChild(this.svgElement);if(this.SVGBBoxTool==null){this.SVGBBoxTool=new SVGBBoxTool(this);}};defineSetterGetter(SVGWallpaperTool.Parts.prototype,"scale",function(scale){this.scaleX=scale;this.scaleY=Math.abs(scale);this._scale=scale;},function(){return this._scale;});SVGWallpaperTool.Parts.prototype.activate=function(){if(!this.active){var self=this;this.setStartDrag();self.addEventListener('mousedown',function(){self.setStartDrag();});this.SVGBBoxTool.enable();$(this).trigger("activated");}
this.active=true;};SVGWallpaperTool.Parts.prototype.deactive=function(){if(this.active){this.SVGBBoxTool.disable();this.active=false;$(this).trigger("deactivated");}};SVGWallpaperTool.Parts.prototype.setStartDrag=function(){var self=this;this.startDrag(false);window.addEventListener('mouseup',function(){self.stopDrag();},false);};SVGWallpaperTool.WallpaperSizeSelectorView=function(selectElement){this.selectElement=$(selectElement);var self=this;this.selectElement.bind("change",function(){$(self).trigger("change");});};SVGWallpaperTool.WallpaperSizeSelectorView.prototype.getWidth=function(){var value=this.selectElement.val().split("x");return value[0];};SVGWallpaperTool.WallpaperSizeSelectorView.prototype.getHeight=function(){var value=this.selectElement.val().split("x");return value[1];};SVGWallpaperTool.WallpaperSizeSelectorController=function(sizeSelectorView,wallpaper){this.sizeSelectorView=sizeSelectorView;this.wallpaper=wallpaper;this.changeHandler(null);var self=this;$(this.sizeSelectorView).bind("change",function(e){self.changeHandler(e)});};SVGWallpaperTool.WallpaperSizeSelectorController.prototype.changeHandler=function(e){var width=this.sizeSelectorView.getWidth();var height=this.sizeSelectorView.getHeight();this.wallpaper.setViewBox(width,height);};SVGWallpaperTool.PartsControllView=function(wallpaper,parentElement,options){this.wallpaper=wallpaper;this.parentElement=$(parentElement);this.isEnable=false;this.init(options);var self=this;$(this.wallpaper).bind("parts_activated",function(){self.enable();});$(this.wallpaper).bind("parts_deactivated",function(){self.disable();});};SVGWallpaperTool.PartsControllView.prototype.init=function(options){var html='<dl>';html+='<dt>Transparency :</dt>';html+='<dd><div class="alphaControll"></div></dd>';html+='<dt>Flip :</dt>';html+='<dd><div class="flipHorizontallyControll"></div><div class="flipVerticallyControll"></div></dd>';html+='<dt>Ordering/Delete :</dt>';html+='<dd><div class="upIndexControll"></div><div class="downIndexControll"></div><div title="remove element" class="removeControll"></div></dd>';html+='</dl>';html+='<div class="removeDialog"><p>Do you want to delete this element?</p></div>';this.parentElement.html(html);this.alphaControll=this._createSlider("alphaControll",options.alpha);this.flipHorizontallyControll=this.parentElement.find(".flipHorizontallyControll").button({icons:{primary:"ui-icon-triangle-2-n-s"},text:false,disabled:true});this.flipVerticallyControll=this.parentElement.find(".flipVerticallyControll").button({icons:{primary:"ui-icon-triangle-2-e-w"},text:false,disabled:true});this.upIndexControll=this.parentElement.find(".upIndexControll").button({icons:{primary:"ui-icon-circle-triangle-n"},text:false,disabled:true});this.downIndexControll=this.parentElement.find(".downIndexControll").button({icons:{primary:"ui-icon-circle-triangle-s"},text:false,disabled:true});this.removeControll=this.parentElement.find(".removeControll").button({icons:{primary:"ui-icon-circle-close"},text:false,disabled:true});this.removeDialog=this.parentElement.find(".removeDialog").dialog({autoOpen:false,modal:true,width:400});this.disable();};SVGWallpaperTool.PartsControllView.prototype._createSlider=function(className,option){var min=(typeof option.min=="number")?option.min:0;var max=(typeof option.max=="number")?option.max:100;var step=(typeof option.step=="number")?option.step:1;var slider=this.parentElement.find("."+className).slider({range:"min",min:min,max:max,step:step,disabled:true});return slider;};SVGWallpaperTool.PartsControllView.prototype.enable=function(){if(this.wallpaper.activeParts!=null){var parts=this.wallpaper.activeParts;this.alphaControll.slider("enable").slider("value",parts.alpha);this.flipHorizontallyControll.button("enable");this.flipVerticallyControll.button("enable");this.upIndexControll.button("enable");this.downIndexControll.button("enable");this.removeControll.button("enable");this.parentElement.css({opacity:1});this.isEnable=true;}};SVGWallpaperTool.PartsControllView.prototype.disable=function(){this.alphaControll.slider("disable");this.flipHorizontallyControll.button("disable");this.flipVerticallyControll.button("disable");this.upIndexControll.button("disable");this.downIndexControll.button("disable");this.removeControll.button("disable");this.parentElement.css({opacity:.3});this.isEnable=false;};SVGWallpaperTool.PartsControllController=function(wallpaper,partsControllView){this.wallpaper=wallpaper;this.partsControllView=partsControllView;this.init();};SVGWallpaperTool.PartsControllController.prototype.init=function(){var partsControllView=this.partsControllView;var self=this;partsControllView.alphaControll.bind("slide",function(event,ui){self.wallpaper.activeParts.alpha=ui.value;});partsControllView.flipVerticallyControll.bind("click",function(){if(partsControllView.isEnable){self.wallpaper.activeParts.scaleX*=-1;self.wallpaper._refresh();}});partsControllView.flipHorizontallyControll.bind("click",function(){if(partsControllView.isEnable){self.wallpaper.activeParts.scaleY*=-1;self.wallpaper._refresh();}});partsControllView.upIndexControll.bind("click",function(){if(partsControllView.isEnable){self.wallpaper.upPartsIndex(self.wallpaper.activeParts);}});partsControllView.downIndexControll.bind("click",function(){if(partsControllView.isEnable){self.wallpaper.downPartsIndex(self.wallpaper.activeParts);}});partsControllView.removeControll.bind("click",function(){if(partsControllView.isEnable){partsControllView.removeDialog.dialog("option","buttons",{"Ok":function(){self.wallpaper.removeParts(self.wallpaper.activeParts);$(this).dialog("close");},"Cancel":function(){$(this).dialog("close");}}).dialog("open");}});};SVGWallpaperTool.PartsListView=function(partsList){this.partsListElement=$(partsList);this.list=this.partsListElement.find("> li a");this.init();var self=this;this.list.click(function(){self.select(this);return false;});};SVGWallpaperTool.PartsListView.prototype.init=function(){this.appendSVGDropBox();};SVGWallpaperTool.PartsListView.prototype.appendSVGDropBox=function(){var svgDropBox=new SVGDropBox({width:70,height:70});var list=document.createElement("li");list.appendChild(svgDropBox.element);this.partsListElement.append(list);var self=this;$(list).click(function(){self.select(svgDropBox,true);});svgDropBox.element.addEventListener("drop",function(e){e.stopPropagation();e.preventDefault();if(svgDropBox.validFile){self.appendSVGDropBox();}},false);};SVGWallpaperTool.PartsListView.prototype.select=function(selectedList,isSVGDropBox){this.selectedListIsSVGDropBox=(typeof isSVGDropBox=="boolean")?isSVGDropBox:false;this.selected=selectedList;$(this).trigger("selected");};SVGWallpaperTool.PartsListController=function(wallpaper,partsListView){this.wallpaper=wallpaper;this.partsListView=partsListView;var self=this;$(this.partsListView).bind("selected",function(){self.selectedHandler();});};SVGWallpaperTool.PartsListController.prototype.selectedHandler=function(){if(this.partsListView.selectedListIsSVGDropBox){var svgDropBox=this.partsListView.selected;if(typeof svgDropBox.fileType!="undefined"){var svgElement;if(svgDropBox.fileType=="svg"){svgElement=document.importNode(svgDropBox.content,true);}else if(svgDropBox.fileType=="image"){var width=svgDropBox.contentElement.naturalWidth;var height=svgDropBox.contentElement.naturalHeight;svgString='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">';svgString+='<image xlink:href="'+svgDropBox.content+'" width="'+width+'" height="'+height+'" />';svgString+='</svg>';var parser=new DOMParser();var svgDoc=parser.parseFromString(svgString,"text/xml");var svgElement=document.importNode(svgDoc.getElementsByTagName("svg")[0],true);}
this.wallpaper.loadParts({svgElement:svgElement});}}else{var url=$(this.partsListView.selected).attr("href");this.wallpaper.loadParts({file:url});}};SVGWallpaperTool.BackgroundListController=function(wallpaper,element){this.wallpaper=wallpaper;this.list=$(element).find("> li a");var self=this;this.list.click(function(){self.select(this);return false;});};SVGWallpaperTool.BackgroundListController.prototype.select=function(element){var url=$(element).attr("href");this.wallpaper.loadBackground(url);};SVGWallpaperTool.DownloadButtonController=function(wallpaper,buttunElement){this.wallpaper=wallpaper;this.buttonElement=$(buttunElement);var self=this;this.buttonElement.mouseover(function(){this.href=self.wallpaper.toDataURL();});};SVGWallpaperTool.IndicatorView=function(wallpaper,indicatorElement){this.wallpaper=wallpaper;this.element=$(indicatorElement);var self=this;$(this.wallpaper).bind("load_start",function(){self.onLoadingStarted();});$(this.wallpaper).bind("load_all_complete",function(){self.onLoadingAllCompleted();});$(this.wallpaper).bind("parts_fulled",function(){self.onPartsFulled()});};SVGWallpaperTool.IndicatorView.prototype.onLoadingStarted=function(){this.element.html('<span class="svgWallpaperTool_loading">Loading...</span>');};SVGWallpaperTool.IndicatorView.prototype.onLoadingAllCompleted=function(){this.element.html('');};SVGWallpaperTool.IndicatorView.prototype.onPartsFulled=function(){this.element.html('Can not add any more parts!');};global.SVGWallpaperTool=SVGWallpaperTool;})(this);